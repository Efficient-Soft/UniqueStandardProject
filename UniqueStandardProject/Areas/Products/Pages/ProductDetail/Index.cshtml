@page
@model UniqueStandardProject.Areas.Products.Pages.ProductDetail.IndexModel
@{
    ViewData["Title"] = "Index | ProductDetail";
    ViewData["pageTitle"] = "Dashboard";
    ViewData["pTitle"] = "ProductDetail";
    ViewData["pSubTitle"] = "Products Detail";
}

@section styles{
    <!-- DataTables -->
    <link href="~/assets/libs/datatables.net-bs4/css/dataTables.bootstrap4.min.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/libs/datatables.net-buttons-bs4/css/buttons.bootstrap4.min.css" rel="stylesheet" type="text/css" />
    <!-- Responsive datatable examples -->
    <link href="~/assets/libs/datatables.net-responsive-bs4/css/responsive.bootstrap4.min.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/libs/datatables.net-select-bs4/css/select.bootstrap4.min.css" rel="stylesheet" type="text/css" />

    <!-- Sweet Alert-->
    <link href="~/assets/libs/sweetalert2/sweetalert2.min.css" rel="stylesheet" type="text/css" />
    <link href="~/css/datatable-custom.css" rel="stylesheet" />

    <link href="~/assets/libs/select2/css/select2.min.css" rel="stylesheet" type="text/css" />
}

<div class="row d-flex justify-content-center">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-xl-3 col-lg-6 mb-lg-0 mb-2">
                        <button id="btnCreate" type="button" class="btn btn-light"><i class="fa fa-plus-circle"></i>&nbsp;Create</button>
                        <button id="btnDelete" type="button" class="btn btn-light"><i class="fa fa-trash"></i>&nbsp;Delete</button>
                        <button id="btnExcel" type="button" class="btn btn-light"><i class="fa fa-file-excel"></i>&nbsp;Excel</button>
                    </div>
                    <div class="col-xl-3 col-lg-6 mb-lg-0 mb-2 ">
                        <select id="ddlProduct" class="form-control form-select select2" required></select>
                    </div>
                    <div class="col-xl-4 offset-xl-2  col-lg-6">
                        <div class="input-group">
                            <label class="input-group-text bg-light"><i class="bx bx-search"></i></label>
                            <input id="TxtSearch" class="form-control" type="text" placeholder="Search for something..." />
                        </div>
                        <span id="LblSearchCount" class="badge bg-light px-2 py-2 search-count"></span>
                    </div>

                </div>
                <table id="tblProductDetail" class="table dt-responsive  nowrap w-100">
                    <thead class="bg-light">
                        <tr>
                            <th scope="col"></th>
                            <th scope="col">#</th>
                            <th scope="col">Product</th>
                            <th scope="col">Image</th>
                            <th scope="col">Title</th>
                            <th scope="col">Description</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- JAVASCRIPT -->
<partial name="_vendor_scripts" />
<partial name="_vendor_datatable_scripts" />
<partial name="_DeleteProductDetail" />

<!-- Sweet Alerts js -->
<script src="~/assets/libs/sweetalert2/sweetalert2.min.js"></script>

<script src="~/assets/libs/select2/js/select2.min.js"></script>

<!-- JAVASCRIPT -->
<script src="~/assets/js/app_sub.js"></script>


<script>
    
    $(document).ready(function () {
        // GET QUERY String Value
        //var detailId = (new URL(location.href)).searchParams.get('detailId');
        //var productId = (new URL(location.href)).searchParams.get('productId');

        var url = "/api/products/productDetail";

        var table = $('#tblProductDetail').DataTable({
            scrollX: true,
            responsive: false,
			ajax: url,
			dom: '<"top"f>rt<"bottom"ilp><"clear">',
			lengthMenu: [
				[10, 25, 50, 100, -1],
				['10', '25', '50', '100', 'All']
            ],
            buttons: [{
				extend: "excelHtml5",
				className: "btn-success",
				title: ('@ViewBag.pSubTitle' +' Report'+' (@DateTime.Now.ToString("dd-MMM-yyyy"))').trim(' '),
				exportOptions: {
					orthogonal: "myExport", columns: 'th:not(:first-child)'
				}
            }],
			columns: [
				{
					defaultContent: '',
					width: "2.5%",
					render: function () {
						return '<input type="checkbox" class="form-check-input" style="margin-inline:25%">'
					},
					ordering: false,
					orderable: false,
				},
                { data: "detailId"},
                { data: "product" },
                {
                    data: "img",
                    render: function (data) {
                        if (data == null) {
                            return '<image src="/images/thumbnail.jpg" class="image-fluid type-image" />'
                        }
                        else {
                            return '<image src="/' + data + '" class="image-fluid type-image" />'
                        }
                    }
                },
                { data: "title" },
                { data: "description" },
                {
                    data: "null",
                    render: function (data, type, row) {
                        var hrefUrl = '/products/productImg/create?detailId=' + row.detailId
                        return '<a href="' + hrefUrl + '" class="btn btn-sm btn-light">ProductImg&nbsp;&nbsp;<i class="fa fa-arrow-right"></i></a>';
                    },
                    width: "5%"
                }
			],
            order: [[1, "asc"]],
			"select": {
				"style": 'os'
			},
			retrieve: true
		});

		table.on('select', function (e, dt, type, indexes) {
			$('input[type="checkbox"]', table.rows().nodes()).prop('checked', false);
			if (type === 'row') { $('input[type="checkbox"]', table.rows(indexes).nodes()).prop('checked', true); }
		});

		table.on('deselect', function (e, dt, type, indexes) {
			$('input[type="checkbox"]', table.rows(indexes).nodes()).prop('checked', false);
        });

        $('#btnCreate').click(function () {
            let productId = $('#ddlProduct').val();
            window.location.href = `productDetail/Create?productId=${productId}`;
        });

        $.getJSON("/api/products", function (data) {
            var states = data["data"];
            var items = '';
            items += "<option selected value='0'>ALL</option>";
            $('#ddlProduct').empty();
            $.each(states, function (i, state) {
                items += "<option class='select2-item' value='" + state.productId + "'>" + state.product1 + "</option>";
            });
            $('#ddlProduct').html(items);
            $('#ddlProduct').select2();
        });

        $('#ddlProduct').change(function (e) {
            console.log('DDL Change')

            var id = $('#ddlProduct').val();
            url = "/api/products/productDetail?productId=" + id;

            console.log(url);

            table.ajax.url(url);
            table.ajax.reload();
        });

        //#region delete product detail
        $('#btnDelete').click(function () {
            $('#DeleteModalLabel').text("Delete Confirmation");
            var selectedItem = table.rows({ selected: true }).data()[0];

            if (selectedItem != null) {
                $('#LblSearchCount').hide();
                $('#DeleteProductDetail').modal('show');
                $('#lblProduct').text(selectedItem.product);
                $('#lblTitle').text(selectedItem.title);
            }
            else {
                $('#DeleteProductDetail').modal('hide');
            }
        });
        //#endregion

        //#region cancel button
        $('#btnDeleteCancel').click(function () {
            $('#DeleteProductDetail').modal('hide');
            $('#lblSearchCount').show();
            table.ajax.reload();
        });
        //#endregion

        //#region productDetail delete confirm
        $('#btnDeleteConfirm').click(function () {
            $('#DeleteProductDetail').modal('hide');
            var selectedItem = table.rows({ selected: true }).data()[0];
            var detailId = selectedItem.detailId;
            var productId = selectedItem.productId;
            $.ajax({
                url: "/api/products/productDetail/delete?detailId=" + detailId + "&productId=" + productId,
                type: 'POST',
                dataType: 'json',
                success: function (data) {
                    notification('success', "ProductDetail has beeen deleted!", "Successfully!");
                    table.ajax.reload();
                },
                error: function (data) {
                    notification('warning', "Can't delete,This Product is not deleted!", "Warning!");
                    table.ajax.reload();
                },
                complete: function (data) {
                    table.ajax.reload();
                }
            });
        });
            //#endregion
    });
</script>
